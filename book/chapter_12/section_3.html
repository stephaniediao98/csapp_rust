<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Concurrent Programming with Threads</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Draft chapter</div></li><li class="chapter-item expanded "><a href="../chapter_2/chapter_2.html"><strong aria-hidden="true">2.</strong> Representing and Manipulating Information</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Draft chapter</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Draft chapter</div></li><li class="chapter-item expanded "><a href="../chapter_5/chapter_5.html"><strong aria-hidden="true">5.</strong> Optimizing Program Performance</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Draft chapter</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.</strong> Draft chapter</div></li><li class="chapter-item expanded "><a href="../chapter_8/chapter_8.html"><strong aria-hidden="true">8.</strong> Exceptional Control Flow</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Draft chapter</div></li><li class="chapter-item expanded "><a href="../chapter_10/chapter_10.html"><strong aria-hidden="true">10.</strong> System-Level I/O</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_10/section_1.html"><strong aria-hidden="true">10.1.</strong> Unix I/O</a></li><li class="chapter-item expanded "><a href="../chapter_10/section_2.html"><strong aria-hidden="true">10.2.</strong> Files</a></li><li class="chapter-item expanded "><a href="../chapter_10/section_3.html"><strong aria-hidden="true">10.3.</strong> Opening and Closing Files</a></li><li class="chapter-item expanded "><a href="../chapter_10/section_4.html"><strong aria-hidden="true">10.4.</strong> Reading and Writing Files</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.5.</strong> Robust Reading and Writing with the Rio Package</div></li><li class="chapter-item expanded "><a href="../chapter_10/section_6.html"><strong aria-hidden="true">10.6.</strong> Reading File Metadata</a></li><li class="chapter-item expanded "><a href="../chapter_10/section_7.html"><strong aria-hidden="true">10.7.</strong> Reading Directory Contents</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.8.</strong> Sharing Files</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.9.</strong> I/O Redirection</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.10.</strong> Standard I/O (Omitted)</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.11.</strong> Putting it Together: Which I/O Functions Should I Use?</div></li></ol></li><li class="chapter-item expanded "><a href="../chapter_11/chapter_11.html"><strong aria-hidden="true">11.</strong> Network Programming</a></li><li class="chapter-item expanded "><a href="../chapter_12/chapter_12.html"><strong aria-hidden="true">12.</strong> Concurrent Programming</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../chapter_12/section_1.html"><strong aria-hidden="true">12.1.</strong> Concurrent Programming with Processes</a></li><li class="chapter-item expanded "><a href="../chapter_12/section_2.html"><strong aria-hidden="true">12.2.</strong> Concurrent Programming with I/O Multiplexing</a></li><li class="chapter-item expanded "><a href="../chapter_12/section_3.html" class="active"><strong aria-hidden="true">12.3.</strong> Concurrent Programming with Threads</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="123---concurrent-programming-with-threads"><a class="header" href="#123---concurrent-programming-with-threads">12.3:   Concurrent Programming with Threads</a></h1>
<p>Thus far, we have looked at two approaches to writing concurrent programs: using processes and using I/O multiplexing. In this section, we discuss a third approach using threads that is a hybrid of these two. We also discuss how to use Rust's <a href="https://doc.rust-lang.org/std/thread/"><code>std::thread</code></a> crate to perform concurrency. </p>
<h2 id="1231---threads"><a class="header" href="#1231---threads">12.3.1   Threads</a></h2>
<p>A <strong>thread</strong> is a logical flow that runs within the context of a process. Most modern operating systems run multiple threads concurrently in a single process. </p>
<p>Just like processes, threads are scheduled automatically by the kernel. Furthermore, every thread has its own <strong>thread context</strong>, which includes its <strong>thread ID (TID)</strong>, stack, stack pointer, program counter, general-purpose registers, and condition codes. All threads that run within a process share the process's virtual address space, which includes its code, data, heap, shared libraries, and open files.</p>
<h2 id="1232---thread-execution-model"><a class="header" href="#1232---thread-execution-model">12.3.2   Thread Execution Model</a></h2>
<p>TODO! <a href="https://doc.rust-lang.org/std/thread/">helpful link</a></p>
<h2 id="1233---posix-threads"><a class="header" href="#1233---posix-threads">12.3.3   Posix Threads</a></h2>
<p>TODO!</p>
<h2 id="1234---creating-threads"><a class="header" href="#1234---creating-threads">12.3.4   Creating Threads</a></h2>
<p>Rust provides the <a href="https://doc.rust-lang.org/std/thread/fn.spawn.html"><code>thread::spawn</code></a> function for creating new threads. </p>
<pre><code class="language-rust ignore">pub fn spawn&lt;F, T&gt;(f: F) -&gt; JoinHandle&lt;T&gt; 
where
    F: FnOnce() -&gt; T,
    F: Send + 'static,
    T: Send + 'static, 
</code></pre>
<p>The <code>spawn</code> function creates a new thread and returns a <a href="https://doc.rust-lang.org/std/thread/struct.JoinHandle.html"><code>JoinHandle</code></a> for it. The <code>JoinHandle</code> struct represents an owned permission to join on a thread. It detaches the child thread when it is dropped, which means that there is no longer any handle to the thread and thus no way to <a href="https://doc.rust-lang.org/std/thread/struct.JoinHandle.html#method.join"><code>join</code></a> on it. The <code>join</code> method is implemented for <code>JoinHandle</code>s and is used to join the child thread. </p>
<p>There are two constraints on both the closure argument <code>F</code> given to <code>spawn</code> and its return value <code>T</code>: </p>
<ul>
<li><em>Static:</em> The <code>'static</code> constraint indicates that the closure and its return value must have a lifetime of the whole program execution. Because threads can detach and outlive the lifetime they have been created in, we need to ensure that they are valid after they outlive their caller. However, since we don't know exactly how long they will be valid, we use the <code>'static</code> constraint to keep them valid as long as possible.</li>
<li><em>Send:</em> The <code>Send</code> trait is automatically implemented by the Rust compiler on types that can be transferred across thread boundaries. An example of a non-<code>Send</code> type is <a href="https://doc.rust-lang.org/std/rc/struct.Rc.html"><code>rc::Rc</code></a>, which is a single-threaded reference-counting pointer. This is a non-<code>Send</code> type because if two threads attempt to clone <code>Rc</code>s that point to the same reference-counted value, then they might cause a race condition if they both try to update the reference count at the same time. This produces undefined behavior because <code>Rc</code> doesn't use atomic operations. In the context of <code>spawn</code>, the closure needs to be passed in <em>by value</em> from the thread where it is spawned to the new thread, which means its return value will be passed from the new thread to the thread where it is <code>join</code>ed, so it has to implement <code>Send</code>.</li>
</ul>
<blockquote>
<p><strong>New to Rust?</strong> TODO! Discuss closures and lifetimes.</p>
</blockquote>
<p>Now, let's try to create a new thread. In the example below, we will use <code>println!</code> statements to show the activities of two threads running concurrently. Try clicking the play button to see what the program outputs.</p>
<pre><pre class="playground"><code class="language-rust">use std::thread;
use std::time::Duration;

fn main() {
    thread::spawn(|| {
        for i in 1..10 {
            println!(&quot;This is {} from the spawned thread.&quot;, i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 1..5 {
        println!(&quot;This is {} from the main thread.&quot;, i);
        thread::sleep(Duration::from_millis(1));
    }
}
</code></pre></pre>
<p>You may have noticed that the child thread never got past <code>i</code> = 4. This is because it was dropped after the main thread ended. </p>
<p><code>thread::sleep</code> is a method that forces a thread to stop its execution for a short duration. This allows another thread to run during that time. The threads will probably take turns, but this behavior is not guaranteed -- it is platform-dependent.</p>
<p>Now, let's try a more advanced example, where we use the <code>JoinHandle</code> struct returned by <code>thread::spawn</code>. We can use <code>JoinHandle</code>'s <code>join</code> method in order to make a thread wait for other threads to finish. This could solve our problem of not getting past <code>i</code> = 4 in the previous example!</p>
<pre><pre class="playground"><code class="language-rust">use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 1..10 {
            println!(&quot;This is {} from the spawned thread.&quot;, i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 1..5 {
        println!(&quot;This is {} from the main thread.&quot;, i);
        thread::sleep(Duration::from_millis(1));
    }

    handle.join().unwrap();
}
</code></pre></pre>
<p>The <code>join</code> call at the end of the program <strong>blocks</strong> the thread that is currently running until the thread represented by the handle (in this case, the spawned child thread) terminates. When a thread is <strong>blocked</strong>, it is prevented from performing work or exiting. Now, try clicking the play button to see if the output of this example is any different than that of the previous example.</p>
<p>We've covered the basics of <code>thread::spawn</code> and <code>JoinHandle</code>, so now it's your turn. Try out the exercises below:</p>
<ul>
<li>Try moving the <code>handle.join()</code> call from the previous example to a different location in the program. Did any of the <code>println!</code> statements change? If so, why do you think they did? </li>
</ul>
<h3 id="1235---sharing-data-among-threads"><a class="header" href="#1235---sharing-data-among-threads">12.3.5   Sharing Data Among Threads</a></h3>
<p>The <code>move</code> closure can be used alongside <code>thread::spawn</code> to allow you to use data from one thread in another. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../chapter_12/section_2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../chapter_12/section_2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        
        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>
        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
